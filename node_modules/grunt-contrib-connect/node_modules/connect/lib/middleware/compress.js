/*!
 * Connect - compress
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var zlib=require("zlib");exports.methods={gzip:zlib.createGzip,deflate:zlib.createDeflate},exports.filter=function(e,t){return/json|text|javascript/.test(t.getHeader("Content-Type"))},module.exports=function(t){t=t||{};var n=Object.keys(exports.methods),r=t.filter||exports.filter;return function(i,s,o){var u=i.headers["accept-encoding"],a=s.getHeader("Vary"),f=s.write,l=s.end,c,h;a?~a.indexOf("Accept-Encoding")||s.setHeader("Vary",a+", Accept-Encoding"):s.setHeader("Vary","Accept-Encoding"),i.on("close",function(){s.write=s.end=function(){}}),s.write=function(e,t){return this.headerSent||this._implicitHeader(),c?c.write(new Buffer(e,t)):f.call(s,e,t)},s.end=function(e,t){return e&&this.write(e,t),c?c.end():l.call(s)},s.on("header",function(){var e=s.getHeader("Content-Encoding")||"identity";if("identity"!=e)return;if(!r(i,s))return;if(!u)return;if("HEAD"==i.method)return;"*"==u.trim()&&(h="gzip");if(!h)for(var o=0,a=n.length;o<a;++o)if(~u.indexOf(n[o])){h=n[o];break}if(!h)return;c=exports.methods[h](t),s.setHeader("Content-Encoding",h),s.removeHeader("Content-Length"),c.on("data",function(e){f.call(s,e)}),c.on("end",function(){l.call(s)}),c.on("drain",function(){s.emit("drain")})}),o()}};