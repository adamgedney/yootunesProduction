/*!
 * Connect - cookieSession
 * Copyright(c) 2011 Sencha Inc.
 * MIT Licensed
 */

var utils=require("./../utils"),Cookie=require("./session/cookie"),debug=require("debug")("connect:cookieSession"),signature=require("cookie-signature"),crc32=require("buffer-crc32");module.exports=function(t){t=t||{};var n=t.key||"connect.sess",r=t.proxy;return function(i,s,o){var u=t.secret||i.secret;if(!u)throw new Error("`secret` option required for cookie sessions");i.session={};var a=i.session.cookie=new Cookie(t.cookie);if(0!=i.originalUrl.indexOf(a.path))return o();if(!t.secret&&i.secret)i.session=i.signedCookies[n]||{},i.session.cookie=a;else{var f=i.cookies[n];if(f){var l=utils.parseSignedCookie(f,u);if(l){var c=crc32.signed(l);i.session=utils.parseJSONCookie(l)||{},i.session.cookie=a}}}s.on("header",function(){if(!i.session){debug("clear session"),a.expires=new Date(0),s.setHeader("Set-Cookie",a.serialize(n,""));return}delete i.session.cookie;var e=(i.headers["x-forwarded-proto"]||"").toLowerCase(),t=i.connection.encrypted||r&&"https"==e,o=a.secure&&t;if(a.secure&&!o)return debug("not secured");debug("serializing %j",i.session);var f="j:"+JSON.stringify(i.session);if(c==crc32.signed(f))return debug("unmodified session");f="s:"+signature.sign(f,u),f=a.serialize(n,f),debug("set-cookie %j",a),s.setHeader("Set-Cookie",f)}),o()}};