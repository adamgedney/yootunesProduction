/*!
 * Connect - json
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

function noop(e,t,n){n()}var utils=require("../utils"),_limit=require("./limit");exports=module.exports=function(e){var e=e||{},t=e.strict!==!1,n=e.limit?_limit(e.limit):noop;return function(i,s,o){if(i._body)return o();i.body=i.body||{};if(!utils.hasBody(i))return o();if("application/json"!=utils.mime(i))return o();i._body=!0,n(i,s,function(n){if(n)return o(n);var r="";i.setEncoding("utf8"),i.on("data",function(e){r+=e}),i.on("end",function(){var n=r.trim()[0];if(0==r.length)return o(utils.error(400,"invalid json, empty body"));if(t&&"{"!=n&&"["!=n)return o(utils.error(400,"invalid json"));try{i.body=JSON.parse(r,e.reviver)}catch(s){return s.body=r,s.status=400,o(s)}o()})})}};