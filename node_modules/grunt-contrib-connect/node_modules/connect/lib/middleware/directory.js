/*!
 * Connect - directory
 * Copyright(c) 2011 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

/*!
 * Icon cache.
 */

function htmlPath(e){var t=[];return e.split("/").map(function(e){return t.push(e),'<a href="'+t.join("/")+'">'+e+"</a>"}).join(" / ")}function html(e,t,n){return'<ul id="files">'+e.map(function(e){var r="",i=[];return n&&".."!=e&&(r=icons[extname(e)]||icons.default,r='<img src="data:image/png;base64,'+load(r)+'" />',i.push("icon")),'<li><a href="'+join(t,e)+'" class="'+i.join(" ")+'"'+' title="'+e+'">'+r+e+"</a></li>"}).join("\n")+"</ul>"}function load(e){return cache[e]?cache[e]:cache[e]=fs.readFileSync(__dirname+"/../public/icons/"+e,"base64")}function removeHidden(e){return e.filter(function(e){return"."!=e[0]})}var fs=require("fs"),parse=require("url").parse,utils=require("../utils"),path=require("path"),normalize=path.normalize,extname=path.extname,join=path.join,cache={};exports=module.exports=function(t,n){n=n||{};if(!t)throw new Error("directory() root path required");var r=n.hidden,i=n.icons,s=n.filter,t=normalize(t);return function(n,o,u){if("GET"!=n.method&&"HEAD"!=n.method)return u();var a=n.headers.accept||"text/plain",f=parse(n.url),l=decodeURIComponent(f.pathname),c=normalize(join(t,l)),h=parse(n.originalUrl),p=decodeURIComponent(h.pathname),d=c!=t&&c!=t+"/";if(~c.indexOf("\0"))return u(utils.error(400));if(0!=c.indexOf(t))return u(utils.error(403));fs.stat(c,function(e,t){if(e)return"ENOENT"==e.code?u():u(e);if(!t.isDirectory())return u();fs.readdir(c,function(e,t){if(e)return u(e);r||(t=removeHidden(t)),s&&(t=t.filter(s)),t.sort();for(var f in exports)if(~a.indexOf(f)||~a.indexOf("*/*")){exports[f](n,o,t,u,p,d,i);return}u(utils.error(406))})})}},exports.html=function(e,t,n,r,i,s,o){fs.readFile(__dirname+"/../public/directory.html","utf8",function(e,u){if(e)return r(e);fs.readFile(__dirname+"/../public/style.css","utf8",function(e,a){if(e)return r(e);s&&n.unshift(".."),u=u.replace("{style}",a).replace("{files}",html(n,i,o)).replace("{directory}",i).replace("{linked-path}",htmlPath(i)),t.setHeader("Content-Type","text/html"),t.setHeader("Content-Length",u.length),t.end(u)})})},exports.json=function(e,t,n){n=JSON.stringify(n),t.setHeader("Content-Type","application/json"),t.setHeader("Content-Length",n.length),t.end(n)},exports.plain=function(e,t,n){n=n.join("\n")+"\n",t.setHeader("Content-Type","text/plain"),t.setHeader("Content-Length",n.length),t.end(n)};var icons={".js":"page_white_code_red.png",".c":"page_white_c.png",".h":"page_white_h.png",".cc":"page_white_cplusplus.png",".php":"page_white_php.png",".rb":"page_white_ruby.png",".cpp":"page_white_cplusplus.png",".swf":"page_white_flash.png",".pdf":"page_white_acrobat.png","default":"page_white.png"};