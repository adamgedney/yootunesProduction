/*!
 * Connect - multipart
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

function noop(e,t,n){n()}var formidable=require("formidable"),_limit=require("./limit"),utils=require("../utils"),qs=require("qs");exports=module.exports=function(e){e=e||{};var t=e.limit?_limit(e.limit):noop;return function(r,i,s){if(r._body)return s();r.body=r.body||{},r.files=r.files||{};if(!utils.hasBody(r))return s();if("GET"==r.method||"HEAD"==r.method)return s();if("multipart/form-data"!=utils.mime(r))return s();r._body=!0,t(r,i,function(t){function a(e,t,n){Array.isArray(n[e])?n[e].push(t):n[e]?n[e]=[n[e],t]:n[e]=t}if(t)return s(t);var n=new formidable.IncomingForm,i={},o={},u;Object.keys(e).forEach(function(t){n[t]=e[t]}),n.on("field",function(e,t){a(e,t,i)}),n.on("file",function(e,t){a(e,t,o)}),n.on("error",function(t){e.defer||(t.status=400,s(t)),u=!0}),n.on("end",function(){if(u)return;try{r.body=qs.parse(i),r.files=qs.parse(o),e.defer||s()}catch(t){n.emit("error",t)}}),n.parse(r),e.defer&&(r.form=n,s())})}};