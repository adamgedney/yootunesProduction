/*!
 * Connect - HTTPServer
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * MIT Licensed
 */

var http=require("http"),utils=require("./utils"),debug=require("debug")("connect:dispatcher"),app=module.exports={},env=process.env.NODE_ENV||"development";app.use=function(e,t){"string"!=typeof e&&(t=e,e="/");if("function"==typeof t.handle){var n=t;t.route=e,t=function(e,t,r){n.handle(e,t,r)}}return t instanceof http.Server&&(t=t.listeners("request")[0]),"/"==e[e.length-1]&&(e=e.slice(0,-1)),debug("use %s %s",e||"/",t.name||"anonymous"),this.stack.push({route:e,handle:t}),this},app.handle=function(e,t,n){function a(f){var l,c,h,p;o&&(e.url=e.url.substr(1),o=!1),e.url=s+e.url,e.originalUrl=e.originalUrl||e.url,s="",l=r[u++];if(!l||t.headerSent){if(n)return n(f);if(f){t.statusCode<400&&(t.statusCode=500),debug("default %s",t.statusCode),f.status&&(t.statusCode=f.status);var d="production"==env?http.STATUS_CODES[t.statusCode]:f.stack||f.toString();"test"!=env&&console.error(f.stack||f.toString());if(t.headerSent)return e.socket.destroy();t.setHeader("Content-Type","text/plain"),t.setHeader("Content-Length",Buffer.byteLength(d));if("HEAD"==e.method)return t.end();t.end(d)}else{debug("default 404"),t.statusCode=404,t.setHeader("Content-Type","text/plain");if("HEAD"==e.method)return t.end();t.end("Cannot "+e.method+" "+utils.escape(e.originalUrl))}return}try{c=utils.parseUrl(e).pathname,undefined==c&&(c="/");if(0!=c.toLowerCase().indexOf(l.route.toLowerCase()))return a(f);p=c[l.route.length];if(p&&"/"!=p&&"."!=p)return a(f);s=l.route,e.url=e.url.substr(s.length),!i&&"/"!=e.url[0]&&(e.url="/"+e.url,o=!0),debug("%s",l.handle.name||"anonymous");var v=l.handle.length;f?v===4?l.handle(f,e,t,a):a(f):v<4?l.handle(e,t,a):a()}catch(m){a(m)}}var r=this.stack,i=~e.url.indexOf("://"),s="",o=!1,u=0;a()},app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};