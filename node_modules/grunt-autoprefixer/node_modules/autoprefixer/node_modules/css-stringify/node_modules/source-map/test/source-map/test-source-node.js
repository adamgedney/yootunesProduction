/*
 * Copyright 2011 Mozilla Foundation and contributors
 * Licensed under the New BSD license. See LICENSE or:
 * http://opensource.org/licenses/BSD-3-Clause
 */

define(["require","exports","module","../../lib/source-map/source-map-generator","../../lib/source-map/source-map-consumer","../../lib/source-map/source-node"],function(e,t,n){var r=e("../../lib/source-map/source-map-generator").SourceMapGenerator,i=e("../../lib/source-map/source-map-consumer").SourceMapConsumer,s=e("../../lib/source-map/source-node").SourceNode;t["test .add()"]=function(e,t){var n=new s(null,null,null);n.add("function noop() {}"),n.add(new s(null,null,null)),n.add(["function foo() {",new s(null,null,null,"return 10;"),"}"]),e.throws(function(){n.add({})}),e.throws(function(){n.add(function(){})})},t["test .prepend()"]=function(e,t){var n=new s(null,null,null);n.prepend("function noop() {}"),e.equal(n.children[0],"function noop() {}"),e.equal(n.children.length,1),n.prepend(new s(null,null,null)),e.equal(n.children[0],""),e.equal(n.children[1],"function noop() {}"),e.equal(n.children.length,2),n.prepend(["function foo() {",new s(null,null,null,"return 10;"),"}"]),e.equal(n.children[0],"function foo() {"),e.equal(n.children[1],"return 10;"),e.equal(n.children[2],"}"),e.equal(n.children[3],""),e.equal(n.children[4],"function noop() {}"),e.equal(n.children.length,5),e.throws(function(){n.prepend({})}),e.throws(function(){n.prepend(function(){})})},t["test .toString()"]=function(e,t){e.equal((new s(null,null,null,["function foo() {",new s(null,null,null,"return 10;"),"}"])).toString(),"function foo() {return 10;}")},t["test .join()"]=function(e,t){e.equal((new s(null,null,null,["a","b","c","d"])).join(", ").toString(),"a, b, c, d")},t["test .walk()"]=function(e,t){var n=new s(null,null,null,["(function () {\n","  ",new s(1,0,"a.js",["someCall()"]),";\n","  ",new s(2,0,"b.js",["if (foo) bar()"]),";\n","}());"]),r=[{str:"(function () {\n",source:null,line:null,column:null},{str:"  ",source:null,line:null,column:null},{str:"someCall()",source:"a.js",line:1,column:0},{str:";\n",source:null,line:null,column:null},{str:"  ",source:null,line:null,column:null},{str:"if (foo) bar()",source:"b.js",line:2,column:0},{str:";\n",source:null,line:null,column:null},{str:"}());",source:null,line:null,column:null}],i=0;n.walk(function(t,n){e.equal(r[i].str,t),e.equal(r[i].source,n.source),e.equal(r[i].line,n.line),e.equal(r[i].column,n.column),i++})},t["test .replaceRight"]=function(e,t){var n;n=new s(null,null,null,"hello world"),n.replaceRight(/world/,"universe"),e.equal(n.toString(),"hello universe"),n=new s(null,null,null,[new s(null,null,null,"hey sexy mama, "),new s(null,null,null,"want to kill all humans?")]),n.replaceRight(/kill all humans/,"watch Futurama"),e.equal(n.toString(),"hey sexy mama, want to watch Futurama?")},t["test .toStringWithSourceMap()"]=function(e,t){var n=new s(null,null,null,["(function () {\n","  ",new s(1,0,"a.js","someCall","originalCall"),new s(1,8,"a.js","()"),";\n","  ",new s(2,0,"b.js",["if (foo) bar()"]),";\n","}());"]),o=n.toStringWithSourceMap({file:"foo.js"}).map,u=n.toStringWithSourceMap().map;e.ok(o instanceof r,"map instanceof SourceMapGenerator"),e.ok(u instanceof r,"mapWithoutOptions instanceof SourceMapGenerator"),u._file="foo.js",t.assertEqualMaps(e,o.toJSON(),u.toJSON()),o=new i(o.toString());var a;a=o.originalPositionFor({line:1,column:4}),e.equal(a.source,null),e.equal(a.line,null),e.equal(a.column,null),a=o.originalPositionFor({line:2,column:2}),e.equal(a.source,"a.js"),e.equal(a.line,1),e.equal(a.column,0),e.equal(a.name,"originalCall"),a=o.originalPositionFor({line:3,column:2}),e.equal(a.source,"b.js"),e.equal(a.line,2),e.equal(a.column,0),a=o.originalPositionFor({line:3,column:16}),e.equal(a.source,null),e.equal(a.line,null),e.equal(a.column,null),a=o.originalPositionFor({line:4,column:2}),e.equal(a.source,null),e.equal(a.line,null),e.equal(a.column,null)},t["test .fromStringWithSourceMap()"]=function(e,t){var n=s.fromStringWithSourceMap(t.testGeneratedCode,new i(t.testMap)),o=n.toStringWithSourceMap({file:"min.js"}),u=o.map,a=o.code;e.equal(a,t.testGeneratedCode),e.ok(u instanceof r,"map instanceof SourceMapGenerator"),u=u.toJSON(),e.equal(u.version,t.testMap.version),e.equal(u.file,t.testMap.file),e.equal(u.mappings,t.testMap.mappings)},t["test .fromStringWithSourceMap() empty map"]=function(e,t){var n=s.fromStringWithSourceMap(t.testGeneratedCode,new i(t.emptyMap)),o=n.toStringWithSourceMap({file:"min.js"}),u=o.map,a=o.code;e.equal(a,t.testGeneratedCode),e.ok(u instanceof r,"map instanceof SourceMapGenerator"),u=u.toJSON(),e.equal(u.version,t.emptyMap.version),e.equal(u.file,t.emptyMap.file),e.equal(u.mappings.length,t.emptyMap.mappings.length),e.equal(u.mappings,t.emptyMap.mappings)},t["test .fromStringWithSourceMap() complex version"]=function(e,t){var n=new s(null,null,null,["(function() {\n","  var Test = {};\n","  ",new s(1,0,"a.js","Test.A = { value: 1234 };\n"),"  ",new s(2,0,"a.js","Test.A.x = 'xyz';"),"\n","}());\n","/* Generated Source */"]);n=n.toStringWithSourceMap({file:"foo.js"});var o=s.fromStringWithSourceMap(n.code,new i(n.map.toString())),u=o.toStringWithSourceMap({file:"foo.js"}),a=u.map,f=u.code;e.equal(f,n.code),e.ok(a instanceof r,"map instanceof SourceMapGenerator"),a=a.toJSON();var l=n.map.toJSON();t.assertEqualMaps(e,a,l)},t["test .toStringWithSourceMap() merging duplicate mappings"]=function(e,t){var n=new s(null,null,null,[new s(1,0,"a.js","(function"),new s(1,0,"a.js","() {\n"),"  ",new s(1,0,"a.js","var Test = "),new s(1,0,"b.js","{};\n"),new s(2,0,"b.js","Test"),new s(2,0,"b.js",".A","A"),new s(2,20,"b.js"," = { value: ","A"),"1234",new s(2,40,"b.js"," };\n","A"),"}());\n","/* Generated Source */"]);n=n.toStringWithSourceMap({file:"foo.js"});var i=new r({file:"foo.js"});i.addMapping({generated:{line:1,column:0},source:"a.js",original:{line:1,column:0}}),i.addMapping({generated:{line:2,column:2},source:"a.js",original:{line:1,column:0}}),i.addMapping({generated:{line:2,column:13},source:"b.js",original:{line:1,column:0}}),i.addMapping({generated:{line:3,column:0},source:"b.js",original:{line:2,column:0}}),i.addMapping({generated:{line:3,column:4},source:"b.js",name:"A",original:{line:2,column:0}}),i.addMapping({generated:{line:3,column:6},source:"b.js",name:"A",original:{line:2,column:20}}),i.addMapping({generated:{line:3,column:18}}),i.addMapping({generated:{line:3,column:22},source:"b.js",name:"A",original:{line:2,column:40}});var o=n.map.toJSON();i=i.toJSON(),t.assertEqualMaps(e,o,i)},t["test .toStringWithSourceMap() multi-line SourceNodes"]=function(e,t){var n=new s(null,null,null,[new s(1,0,"a.js","(function() {\nvar nextLine = 1;\nanotherLine();\n"),new s(2,2,"b.js","Test.call(this, 123);\n"),new s(2,2,"b.js","this['stuff'] = 'v';\n"),new s(2,2,"b.js","anotherLine();\n"),"/*\nGenerated\nSource\n*/\n",new s(3,4,"c.js","anotherLine();\n"),"/*\nGenerated\nSource\n*/"]);n=n.toStringWithSourceMap({file:"foo.js"});var i=new r({file:"foo.js"});i.addMapping({generated:{line:1,column:0},source:"a.js",original:{line:1,column:0}}),i.addMapping({generated:{line:2,column:0},source:"a.js",original:{line:1,column:0}}),i.addMapping({generated:{line:3,column:0},source:"a.js",original:{line:1,column:0}}),i.addMapping({generated:{line:4,column:0},source:"b.js",original:{line:2,column:2}}),i.addMapping({generated:{line:5,column:0},source:"b.js",original:{line:2,column:2}}),i.addMapping({generated:{line:6,column:0},source:"b.js",original:{line:2,column:2}}),i.addMapping({generated:{line:11,column:0},source:"c.js",original:{line:3,column:4}});var o=n.map.toJSON();i=i.toJSON(),t.assertEqualMaps(e,o,i)},t["test setSourceContent with toStringWithSourceMap"]=function(e,t){var n=new s(1,1,"a.js","a");n.setSourceContent("a.js","someContent");var o=new s(null,null,null,["(function () {\n","  ",n,"  ",new s(1,1,"b.js","b"),"}());"]);o.setSourceContent("b.js","otherContent");var u=o.toStringWithSourceMap({file:"foo.js"}).map;e.ok(u instanceof r,"map instanceof SourceMapGenerator"),u=new i(u.toString()),e.equal(u.sources.length,2),e.equal(u.sources[0],"a.js"),e.equal(u.sources[1],"b.js"),e.equal(u.sourcesContent.length,2),e.equal(u.sourcesContent[0],"someContent"),e.equal(u.sourcesContent[1],"otherContent")},t["test walkSourceContents"]=function(e,t){var n=new s(1,1,"a.js","a");n.setSourceContent("a.js","someContent");var r=new s(null,null,null,["(function () {\n","  ",n,"  ",new s(1,1,"b.js","b"),"}());"]);r.setSourceContent("b.js","otherContent");var i=[];r.walkSourceContents(function(e,t){i.push([e,t])}),e.equal(i.length,2),e.equal(i[0][0],"a.js"),e.equal(i[0][1],"someContent"),e.equal(i[1][0],"b.js"),e.equal(i[1][1],"otherContent")}});